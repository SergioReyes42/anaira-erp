{% extends 'base.html' %}

{% block content %}
<div class="container py-4">

    <div class="alert alert-success d-flex align-items-center mb-3 border-0 shadow-sm" role="alert" style="background-color: #d1e7dd;">
        <i class="bi bi-robot me-2 text-success"></i>
        <small class="fw-bold text-success-emphasis">IA Detectada: LISTO. Sistema preparado para escanear.</small>
        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
    </div>

    <div class="card shadow border-0">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0 fw-bold"><i class="bi bi-receipt me-2"></i>Registrar Gasto / Compra</h5>
            <span class="badge bg-warning text-dark">Manual</span>
        </div>
        
        <div class="card-body p-4">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="border border-primary border-dashed rounded p-4 mb-4 text-center bg-light" style="border-style: dashed !important;">
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <i class="bi bi-qr-code-scan text-primary me-3" style="font-size: 2.5rem;"></i>
                        <div class="text-start">
                            <h6 class="text-primary fw-bold mb-0">Smart Scanner (IA)</h6>
                            <small class="text-muted">Suba su factura aquí y la IA llenará los campos.</small>
                        </div>
                    </div>
                    <div class="input-group">
                        {{ form.invoice_file }}
                        <button class="btn btn-primary fw-bold" type="button">
                            <i class="bi bi-magic me-2"></i>ANALIZAR DOCUMENTO
                        </button>
                    </div>
                </div>

                <h6 class="text-muted mb-3 border-bottom pb-2">Detalle de la Factura</h6>

                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold small">Fecha Emisión</label>
                        {{ form.date }}
                    </div>
                    <div class="col-md-8">
                        <label class="form-label fw-bold small">Proveedor / Emisor</label>
                        {{ form.provider }}
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold small">Descripción / Concepto</label>
                    {{ form.description }}
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-success small">Total (Caja)</label>
                        {{ form.total_amount }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-primary small">IDP (Gasolina)</label>
                        {{ form.idp_amount }}
                        <div class="form-text x-small">No paga IVA</div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small">Base (Gasto Real)</label>
                        {{ form.base_amount }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small">IVA (Crédito)</label>
                        {{ form.vat_amount }}
                    </div>
                </div>

                <div class="bg-light p-3 rounded border mb-4">
                    <div class="form-check form-switch mb-2">
                        {{ form.is_fuel }}
                        <label class="form-check-label fw-bold" for="{{ form.is_fuel.id_for_label }}">¿Es Compra de Combustible o Mantenimiento?</label>
                    </div>
                    <div id="vehicleSelector" style="display: none;">
                        <label class="small text-muted mb-1">Seleccionar Vehículo de la Flotilla:</label>
                        {{ form.vehicle }}
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success fw-bold py-2">
                        <i class="bi bi-save me-2"></i>GUARDAR GASTO
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Script simple para mostrar/ocultar el selector de vehículo
    function toggleVehicle() {
        var checkBox = document.getElementById("id_is_fuel");
        var selector = document.getElementById("vehicleSelector");
        if (checkBox.checked == true){
            selector.style.display = "block";
        } else {
            selector.style.display = "none";
        }
    }
    
    // Asignar el evento al checkbox
    document.getElementById("id_is_fuel").addEventListener('change', toggleVehicle);

    // Calculadora Automática de IVA (Simple)
    const totalInput = document.getElementById('id_total_amount');
    const idpInput = document.getElementById('id_idp_amount');
    const baseInput = document.getElementById('id_base_amount');
    const vatInput = document.getElementById('id_vat_amount');

    function calculateValues() {
        let total = parseFloat(totalInput.value) || 0;
        let idp = parseFloat(idpInput.value) || 0;

        // Formula Guatemala: (Total - IDP) / 1.12 = Base
        let subtotal = total - idp;
        let base = subtotal / 1.12;
        let vat = subtotal - base;

        baseInput.value = base.toFixed(2);
        vatInput.value = vat.toFixed(2);
    }

    totalInput.addEventListener('input', calculateValues);
    idpInput.addEventListener('input', calculateValues);
</script>
{% endblock %}