{% extends 'base.html' %}

{% block content %}
<div class="container-fluid px-4 mt-4">
    <form method="post" id="quoteForm">
        {% csrf_token %}
        
        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-header bg-dark text-white py-2">
                        <h6 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>Datos del Cliente</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.client }}
                        </div>
                        <div class="mb-3">
                            <label class="small fw-bold">Válida hasta:</label>
                            {{ form.valid_until }}
                        </div>
                        <div class="mb-3">
                            <label class="small fw-bold">Pago:</label>
                            {{ form.payment_method }}
                        </div>
                    </div>
                </div>
                
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <label class="small fw-bold">Observaciones:</label>
                        {{ form.observation }}
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-cart4 me-2"></i>Detalle de Productos</h6>
                        <button type="button" class="btn btn-sm btn-light text-primary fw-bold" onclick="addRow()">
                            <i class="bi bi-plus-lg"></i> Agregar Producto
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0" id="detallesTable">
                                <thead class="bg-light text-secondary small">
                                    <tr>
                                        <th style="width: 40%;">Producto</th>
                                        <th style="width: 15%;">Precio (Q)</th>
                                        <th style="width: 15%;">Cantidad</th>
                                        <th style="width: 20%;">Subtotal</th>
                                        <th style="width: 10%;"></th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3" class="text-end fw-bold fs-5">TOTAL:</td>
                                        <td class="fw-bold fs-5 text-primary">Q <span id="grandTotal">0.00</span></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-white text-end">
                        <a href="{% url 'quotation_list' %}" class="btn btn-secondary">Cancelar</a>
                        <button type="submit" class="btn btn-success fw-bold px-4">
                            <i class="bi bi-save me-2"></i>Guardar Cotización
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    /* ==========================================
       LOGICA DE PRODUCTOS Y PRECIOS
       ========================================== */
    
    // 1. Base de datos de productos (pasada desde Django a JS)
    // Usamos stringformat:'f' para que el precio sea un número limpio (ej: 150.00)
    const productsDB = {};
    
    {% for p in products %}
        productsDB["{{ p.id }}"] = {
            name: "{{ p.name|escapejs }}",
            price: {{ p.sale_price|default:0|stringformat:"f" }} 
        };
    {% endfor %}

    // 2. Función para agregar filas
    function addRow() {
        const tbody = document.getElementById('tableBody');
        const rowId = Date.now(); // ID único
        
        // Generar las opciones del Select
        let optionsHtml = '<option value="">-- Seleccionar --</option>';
        for (const [id, data] of Object.entries(productsDB)) {
            optionsHtml += `<option value="${id}">${data.name}</option>`;
        }

        const row = `
            <tr id="row-${rowId}">
                <td>
                    <select name="product_id[]" class="form-select form-select-sm" onchange="updatePrice(this, ${rowId})" required>
                        ${optionsHtml}
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm bg-light text-end" 
                           id="price-${rowId}" name="price[]" readonly value="0.00">
                </td>
                <td>
                    <input type="number" name="qty[]" class="form-control form-control-sm text-center" 
                           value="1" min="1" oninput="calcRow(${rowId})">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm fw-bold border-0 bg-transparent text-end" 
                           id="subtotal-${rowId}" readonly value="0.00">
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger border-0" onclick="removeRow(${rowId})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    }

    // 3. Actualizar precio al seleccionar producto
    function updatePrice(selectElement, rowId) {
        const productId = selectElement.value;
        const priceInput = document.getElementById(`price-${rowId}`);
        
        if (productId && productsDB[productId]) {
            // Asignamos el precio automáticamente
            let precio = parseFloat(productsDB[productId].price);
            priceInput.value = precio.toFixed(2);
        } else {
            priceInput.value = "0.00";
        }
        
        calcRow(rowId); // Recalcular subtotal
    }

    // 4. Calcular Subtotal (Precio * Cantidad)
    function calcRow(rowId) {
        const price = parseFloat(document.getElementById(`price-${rowId}`).value) || 0;
        const qty = parseFloat(document.querySelector(`#row-${rowId} input[name='qty[]']`).value) || 0;
        const subtotal = price * qty;
        
        document.getElementById(`subtotal-${rowId}`).value = subtotal.toFixed(2);
        calcTotal();
    }

    // 5. Eliminar fila
    function removeRow(rowId) {
        const row = document.getElementById(`row-${rowId}`);
        if(row) row.remove();
        calcTotal();
    }

    // 6. Calcular Total General
    function calcTotal() {
        let total = 0;
        document.querySelectorAll("input[id^='subtotal-']").forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        document.getElementById('grandTotal').innerText = total.toFixed(2);
    }

    // Iniciar con una fila vacía al cargar
    window.onload = function() {
        addRow();
    };
</script>
{% endblock %}