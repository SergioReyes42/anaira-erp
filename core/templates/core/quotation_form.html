{% extends 'base.html' %}

{% block content %}
<div class="container-fluid px-4 py-4 bg-light">
    <form method="post" id="quoteForm">
        {% csrf_token %}
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold text-dark mb-0">Nueva Cotizaci√≥n</h4>
                <small class="text-muted">Creando documento comercial</small>
            </div>
            <div class="d-flex align-items-center">
                <div class="text-end me-3">
                    <h6 class="mb-0 fw-bold text-primary">{{ company|upper }}</h6>
                    <span class="badge bg-warning text-dark border border-dark">
                        <i class="bi bi-geo-alt-fill me-1"></i>{{ sucursal_nombre }}
                    </span>
                </div>
                <div class="bg-white p-2 rounded shadow-sm border">
                    <i class="bi bi-person-circle fs-4 text-secondary"></i>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-3 mb-4">
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-person-lines-fill me-2"></i>Cliente</h6>
                    </div>
                    <div class="card-body bg-white">
                        <div class="mb-3">
                            <label class="small text-muted text-uppercase fw-bold">Seleccionar Cliente</label>
                            {{ form.client }}
                            <a href="#" class="small text-decoration-none mt-1 d-block">+ Crear Nuevo Cliente</a>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h6 class="mb-0 fw-bold text-secondary"><i class="bi bi-calendar-event me-2"></i>Condiciones</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="small fw-bold">Fecha Emisi√≥n:</label>
                            {{ form.date }}
                        </div>
                        <div class="mb-3">
                            <label class="small fw-bold">V√°lida hasta:</label>
                            {{ form.valid_until }}
                        </div>
                        <div class="mb-3">
                            <label class="small fw-bold">Forma de Pago:</label>
                            {{ form.payment_method }}
                        </div>
                        <div class="mb-0">
                            <label class="small fw-bold">Notas / Observaciones:</label>
                            {{ form.observation }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-9">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-dark text-white py-3 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-cart4 me-2"></i>Detalle de Items</h6>
                        <button type="button" class="btn btn-sm btn-success fw-bold" onclick="addRow()">
                            <i class="bi bi-plus-circle me-1"></i> Agregar √çtem
                        </button>
                    </div>
                    
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0 align-middle" id="detallesTable">
                                <thead class="bg-light text-secondary small text-uppercase">
                                    <tr>
                                        <th style="width: 45%;" class="ps-3">Producto / Servicio</th>
                                        <th style="width: 15%;" class="text-end">Precio (Q)</th>
                                        <th style="width: 10%;" class="text-center">Cant.</th>
                                        <th style="width: 20%;" class="text-end pe-3">Subtotal</th>
                                        <th style="width: 10%;"></th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody" class="border-top-0">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card-footer bg-white border-top p-4">
                        <div class="row justify-content-end">
                            <div class="col-md-5 col-xl-4">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Subtotal:</span>
                                    <span class="fw-bold">Q <span id="subTotalDisplay">0.00</span></span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center pt-2 border-top border-2">
                                    <span class="fs-5 fw-bold text-dark">TOTAL NETO:</span>
                                    <span class="fs-4 fw-bold text-primary">Q <span id="grandTotal">0.00</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-light text-end py-3">
                        <a href="{% url 'quotation_list' %}" class="btn btn-outline-secondary me-2">Cancelar</a>
                        <button type="submit" class="btn btn-primary px-4 fw-bold shadow-sm">
                            <i class="bi bi-save me-2"></i>Guardar Cotizaci√≥n
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    /* ==========================================
       CONFIGURACI√ìN
       ========================================== */
    const CLAVE_SUPERVISOR = "admin123"; // üîí CAMBIA ESTO POR TU CLAVE REAL

    // 1. Cargar base de datos de productos
    const productsDB = {};
    {% for p in products %}
        productsDB["{{ p.id }}"] = {
            name: "{{ p.name|escapejs }}",
            // Usamos stringformat:"f" para evitar errores de comas/puntos
            price: {{ p.price|default:0|stringformat:"f" }}
        };
    {% endfor %}

    // 2. Funci√≥n para agregar una fila nueva
    function addRow() {
        const tbody = document.getElementById('tableBody');
        const rowId = Date.now();
        
        let optionsHtml = '<option value="">-- Buscar Producto --</option>';
        for (const [id, data] of Object.entries(productsDB)) {
            optionsHtml += `<option value="${id}">${data.name}</option>`;
        }

        const row = `
            <tr id="row-${rowId}">
                <td class="ps-3">
                    <select name="product_id[]" class="form-select" onchange="updatePrice(this, ${rowId})" required>
                        ${optionsHtml}
                    </select>
                </td>
                <td>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0 py-0 px-1 text-muted" style="font-size: 0.7rem;">Q</span>
                        <input type="number" 
                               class="form-control bg-light text-end fw-bold" 
                               id="price-${rowId}" 
                               name="price[]" 
                               readonly 
                               value="0.00"
                               ondblclick="unlockPrice(${rowId})"
                               onblur="lockPrice(${rowId})"
                               title="Doble click para desbloquear (Requiere clave)"
                               step="0.01">
                    </div>
                </td>
                <td>
                    <input type="number" name="qty[]" class="form-control text-center fw-bold" 
                           value="1" min="1" oninput="calcRow(${rowId})">
                </td>
                <td class="pe-3">
                    <input type="text" class="form-control fw-bold border-0 bg-transparent text-end text-dark" 
                           id="subtotal-${rowId}" readonly value="0.00">
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger border-0 rounded-circle" 
                            onclick="removeRow(${rowId})">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    }

    // 3. Actualizar precio autom√°tico al seleccionar
    function updatePrice(selectElement, rowId) {
        const productId = selectElement.value;
        const priceInput = document.getElementById(`price-${rowId}`);
        
        if (productId && productsDB[productId]) {
            let precio = parseFloat(productsDB[productId].price);
            priceInput.value = precio.toFixed(2);
        } else {
            priceInput.value = "0.00";
        }
        calcRow(rowId);
    }

    // 4. FUNCION DE SEGURIDAD: Desbloquear Precio
    function unlockPrice(rowId) {
        const input = document.getElementById(`price-${rowId}`);
        
        // Si ya est√° desbloqueado, no hacemos nada
        if (!input.readOnly) return;

        // Pedir clave
        let password = prompt("üîí CONTROL DE PRECIOS\nIngrese clave de Supervisor para editar:");
        
        if (password === CLAVE_SUPERVISOR) {
            input.readOnly = false; // Quitar candado
            input.classList.remove("bg-light"); // Quitar color gris
            input.classList.add("bg-white", "border-primary"); // Poner blanco y borde azul
            input.focus();
            alert("‚úÖ Precio desbloqueado temporalmente.");
        } else {
            alert("‚õî Clave incorrecta. Acceso denegado.");
        }
    }

    // (Opcional) Volver a bloquear al salir del campo para seguridad
    function lockPrice(rowId) {
        const input = document.getElementById(`price-${rowId}`);
        calcRow(rowId); // Asegurar calculo
        // No lo bloqueamos inmediatamente para no ser molestos, 
        // pero podr√≠as descomentar la linea de abajo si quieres que se bloquee siempre al salir.
        // input.readOnly = true; 
    }

    // 5. C√°lculos Matem√°ticos
    function calcRow(rowId) {
        const price = parseFloat(document.getElementById(`price-${rowId}`).value) || 0;
        const qty = parseFloat(document.querySelector(`#row-${rowId} input[name='qty[]']`).value) || 0;
        const subtotal = price * qty;
        
        document.getElementById(`subtotal-${rowId}`).value = subtotal.toFixed(2);
        calcTotal();
    }

    function removeRow(rowId) {
        const row = document.getElementById(`row-${rowId}`);
        if(row) row.remove();
        calcTotal();
    }

    function calcTotal() {
        let total = 0;
        document.querySelectorAll("input[id^='subtotal-']").forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        document.getElementById('grandTotal').innerText = total.toFixed(2);
        document.getElementById('subTotalDisplay').innerText = total.toFixed(2);
    }

    // Inicializar
    window.onload = function() {
        addRow();
    };
</script>
{% endblock %}