{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            
            <div class="card shadow-lg border-0 border-top border-warning border-4 rounded-4">
                <div class="card-header bg-white border-0 text-center pt-4">
                    <h4 class="fw-bold text-dark"><i class="bi bi-ev-front-fill text-warning me-2"></i>Reporte de Combustible</h4>
                    <p class="text-muted small">El sistema registrará tu ubicación y hora para auditoría.</p>
                </div>
                
                <div class="card-body px-4 pb-4">
                    
                    <div id="gps-status" class="alert alert-secondary py-2 small text-center fw-bold shadow-sm">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        Calibrando GPS... Por favor, permite el acceso a tu ubicación.
                    </div>

                    <div id="error-box" class="alert alert-danger d-none shadow-sm fw-bold" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> <span id="error-message"></span>
                    </div>

                    <form method="POST" enctype="multipart/form-data" id="expenseForm">
                        {% csrf_token %}
                        
                        {{ form.latitude }}
                        {{ form.longitude }}

                        <div class="mb-3">
                            <label class="fw-bold text-secondary mb-1">Monto Gastado (Q)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-success text-white fw-bold">Q</span>
                                {{ form.total_amount }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="fw-bold text-secondary mb-1">Vehículo</label>
                            {{ form.vehicle }}
                        </div>

                        <div class="mb-4">
                            <label class="fw-bold text-secondary mb-1">Descripción del Viaje</label>
                            {{ form.description }}
                        </div>

                        <hr class="mb-4">
                        <h6 class="fw-bold text-danger mb-3"><i class="bi bi-camera-fill me-2"></i>Evidencia Fotográfica Obligatoria</h6>

                        <div class="mb-3 p-3 bg-light border border-2 border-secondary rounded-3">
                            <label class="fw-bold text-dark mb-2">1. Foto de la Factura (NIT)</label>
                            {{ form.receipt_image }}
                        </div>

                        <div class="mb-4 p-3 bg-light border border-2 border-warning rounded-3">
                            <label class="fw-bold text-dark mb-2">2. Foto de la Bomba / Tablero</label>
                            {{ form.pump_image }}
                            <small class="text-muted d-block mt-1">Galones en pantalla o millaje del vehículo.</small>
                        </div>

                        <button type="submit" class="btn btn-warning w-100 fw-bold py-3 shadow-sm fs-5" id="submitBtn">
                            <i class="bi bi-cloud-arrow-up-fill me-2"></i> Enviar Reporte
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusDiv = document.getElementById('gps-status');
    const latInput = document.getElementById('lat_input');
    const lngInput = document.getElementById('lng_input');
    const form = document.getElementById('expenseForm');
    const errorBox = document.getElementById('error-box');
    const errorMessage = document.getElementById('error-message');

    // 1. CAPTURAR GPS AL ABRIR LA PANTALLA
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                latInput.value = position.coords.latitude;
                lngInput.value = position.coords.longitude;
                statusDiv.className = "alert alert-success py-2 small text-center fw-bold shadow-sm";
                statusDiv.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i> GPS Conectado y Listo';
            },
            function(error) {
                statusDiv.className = "alert alert-danger py-2 small text-center fw-bold shadow-sm";
                statusDiv.innerHTML = '<i class="bi bi-geo-alt-fill me-1"></i> ERROR: GPS Apagado o denegado.';
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    // 2. VALIDAR ANTES DE ENVIAR
    form.addEventListener('submit', function(event) {
        let errores = [];
        
        // Verificar GPS
        if (!latInput.value || !lngInput.value) {
            errores.push("Tu GPS no está activado. Activa la ubicación y recarga la página.");
        }

        // Verificar Foto 1 (Factura)
        const fotoFactura = document.getElementById('foto_factura');
        if (fotoFactura.files.length === 0) {
            errores.push("Falta la fotografía de la Factura.");
        }

        // Verificar Foto 2 (Bomba)
        const fotoBomba = document.getElementById('foto_bomba');
        if (fotoBomba.files.length === 0) {
            errores.push("Falta la fotografía de la Bomba de combustible.");
        }

        // Si hay errores, detenemos todo y mostramos la caja roja
        if (errores.length > 0) {
            event.preventDefault(); // Congela el envío al servidor
            errorMessage.innerHTML = errores.join("<br><br><i class='bi bi-x-circle-fill me-1'></i> ");
            errorBox.classList.remove('d-none');
            // Hacer scroll hacia arriba para que el piloto vea el error
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            // Si todo está bien, ocultamos errores y cambiamos el botón a "Enviando..."
            errorBox.classList.add('d-none');
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Subiendo...';
            btn.classList.add('disabled');
        }
    });
});
</script>
{% endblock %}