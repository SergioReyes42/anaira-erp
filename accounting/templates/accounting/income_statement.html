{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3 d-print-none">
        <div>
            <h2 class="fw-bold text-dark"><i class="bi bi-graph-up-arrow text-success me-2"></i> Estado de Resultados</h2>
            <p class="text-muted mb-0">Análisis de Pérdidas y Ganancias del período (Rendimiento Operativo).</p>
        </div>
        <button class="btn btn-outline-dark fw-bold" onclick="window.print()">
            <i class="bi bi-printer-fill me-1"></i> Imprimir Reporte
        </button>
    </div>

    <div class="card shadow-sm border-0 mb-4 bg-white d-print-none">
        <div class="card-body p-3">
            <form method="GET" class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label fw-bold text-muted small">AÑO</label>
                    <select name="anio" class="form-select border-success">
                        {% for a in anios %}
                            <option value="{{ a }}" {% if a == anio_seleccionado %}selected{% endif %}>{{ a }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold text-muted small">MES A EVALUAR</label>
                    <select name="mes" class="form-select border-success">
                        {% for m in meses %}
                            <option value="{{ m }}" {% if m == mes_seleccionado %}selected{% endif %}>Mes {{ m }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100 fw-bold">Generar Reporte</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-lg border-0 print-friendly">
        <div class="card-header bg-dark text-white text-center py-4">
            <h4 class="mb-0 fw-bold text-uppercase">{{ request.user.current_company|default:"LA EMPRESA" }}</h4>
            <h5 class="mb-0 text-light opacity-75">Estado de Resultados Integrales</h5>
            <small>Cifras expresadas en Quetzales (Q) - Del 01 al 31 del mes {{ mes_seleccionado }} del {{ anio_seleccionado }}</small>
        </div>
        
        <div class="card-body p-5">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    
                    <h5 class="fw-bold text-success border-bottom pb-2 mb-3">1. INGRESOS OPERATIVOS</h5>
                    <table class="table table-sm table-borderless mb-4 ms-3 w-100">
                        <tbody>
                            {% for ingreso in ingresos %}
                            <tr>
                                <td class="text-muted font-monospace small" width="15%">{{ ingreso.codigo }}</td>
                                <td width="60%">{{ ingreso.nombre }}</td>
                                <td class="text-end fw-bold" width="25%">{{ ingreso.saldo|floatformat:2 }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-muted fst-italic py-2">No se registraron ingresos en este período.</td></tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="border-top border-dark">
                                <td colspan="2" class="fw-bold text-end pe-4">TOTAL INGRESOS BRUTOS:</td>
                                <td class="text-end fw-bold fs-6 text-success">Q. {{ total_ingresos|floatformat:2 }}</td>
                            </tr>
                        </tfoot>
                    </table>

                    <h5 class="fw-bold text-danger border-bottom pb-2 mb-3 mt-5">2. GASTOS OPERATIVOS Y COSTOS</h5>
                    <table class="table table-sm table-borderless mb-4 ms-3 w-100">
                        <tbody>
                            {% for gasto in gastos %}
                            <tr>
                                <td class="text-muted font-monospace small" width="15%">{{ gasto.codigo }}</td>
                                <td width="60%">{{ gasto.nombre }}</td>
                                <td class="text-end fw-bold">{{ gasto.saldo|floatformat:2 }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-muted fst-italic py-2">No se registraron gastos en este período.</td></tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="border-top border-dark">
                                <td colspan="2" class="fw-bold text-end pe-4">TOTAL GASTOS OPERATIVOS:</td>
                                <td class="text-end fw-bold fs-6 text-danger">(Q. {{ total_gastos|floatformat:2 }})</td>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="card mt-5 {% if utilidad_neta > 0 %}border-success bg-light-success{% elif utilidad_neta < 0 %}border-danger bg-light-danger{% else %}border-secondary bg-light{% endif %} border-2">
                        <div class="card-body p-4 d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="fw-bold mb-0 text-dark">RESULTADO DEL EJERCICIO</h3>
                                <span class="text-muted small">Utilidad o (Pérdida) Neta del mes seleccionado</span>
                            </div>
                            <div class="text-end">
                                <h2 class="fw-bold mb-0 {% if utilidad_neta > 0 %}text-success{% elif utilidad_neta < 0 %}text-danger{% else %}text-secondary{% endif %}">
                                    Q. {{ utilidad_neta|floatformat:2 }}
                                </h2>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-light-success { background-color: #f0fdf4 !important; }
    .bg-light-danger { background-color: #fef2f2 !important; }
    @media print {
        body { background-color: white !important; }
        .card { box-shadow: none !important; border: none !important; }
        .bg-light-success, .bg-light-danger { background-color: white !important; border-color: black !important; }
    }
</style>
{% endblock %}