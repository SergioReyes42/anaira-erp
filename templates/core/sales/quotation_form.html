{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow border-primary">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h3 class="mb-0"><i class="bi bi-file-earmark-text"></i> Nueva Cotizaci贸n</h3>
            <span class="badge bg-white text-primary">Ventas</span>
        </div>
        <div class="card-body">

            <div class="card border-info mb-4 shadow-sm bg-light">
                <div class="card-body p-3">
                    <label class="form-label fw-bold text-info mb-2">
                        <i class="bi bi-magic"></i> Asistente de Ventas IA
                    </label>
                    <div class="input-group">
                        <input type="file" id="aiImage" class="d-none" accept="image/*">
                        
                        <button class="btn btn-outline-info" type="button" onclick="document.getElementById('aiImage').click()">
                            <i class="bi bi-whatsapp"></i> Subir Pedido
                        </button>
                        
                        <input type="text" id="aiPrompt" class="form-control" 
                               placeholder="Ej: 'Juan Perez pide 3 laptops i5 y 2 impresoras Epson'">
                        
                        <button class="btn btn-info text-white" type="button" id="btnMagic">
                            <i class="bi bi-lightning-fill"></i> Autocompletar
                        </button>
                    </div>
                    <small id="fileNameDisplay" class="text-muted ms-2 fst-italic"></small>
                </div>
            </div>
            <form method="post" id="quotationForm">
                {% csrf_token %}
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Cliente:</label>
                        <select name="client" id="id_client" class="form-select" required>
                            <option value="">-- Buscar Cliente --</option>
                            {% for c in clients %}
                                <option value="{{ c.id }}">{{ c.name }} ({{ c.nit }})</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <a href="/admin/core/client/add/" target="_blank" class="text-decoration-none">
                                <i class="bi bi-person-plus"></i> Nuevo Cliente
                            </a>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Fecha:</label>
                        {{ form.date }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Validez (D铆as):</label>
                        {{ form.validity_days }}
                    </div>
                </div>

                <h5 class="mb-3 border-bottom pb-2">Productos a Cotizar</h5>
                <div class="table-responsive mb-3">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Producto / Servicio</th>
                                <th width="100">Cant.</th>
                                <th width="150">Precio Unit.</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody id="productsBody">
                            </tbody>
                    </table>
                </div>

                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addRow()">
                    <i class="bi bi-plus-lg"></i> Agregar Producto
                </button>

                <div class="mt-4 mb-3">
                    <label class="form-label fw-bold">Observaciones / Condiciones:</label>
                    <textarea name="observation" id="id_observation" class="form-control" rows="2" placeholder="Ej: Entrega inmediata, pago al contado..."></textarea>
                </div>

                <hr>

                <div class="d-flex justify-content-end gap-2">
                    <a href="{% url 'quotation_list' %}" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary btn-lg px-5">
                        <i class="bi bi-send"></i> Generar Cotizaci贸n
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="product-data" style="display:none;">
    {% for p in products %}
    <span class="p-item" data-id="{{ p.id }}" data-name="{{ p.name }}" data-price="{{ p.price }}"></span>
    {% endfor %}
</div>

<script>
    // --- 1. LGICA DE PRODUCTOS (TABLA) ---
    const productsList = [];
    document.querySelectorAll('#product-data .p-item').forEach(item => {
        productsList.push({ 
            id: item.dataset.id, 
            name: item.dataset.name, 
            price: item.dataset.price 
        });
    });

    window.addRow = function(preSelectedId = null, preQty = 1) {
        const tbody = document.getElementById('productsBody');
        const row = document.createElement('tr');
        
        let options = '<option value="">-- Seleccionar --</option>';
        productsList.forEach(p => {
            const selected = (preSelectedId && p.id == preSelectedId) ? 'selected' : '';
            options += `<option value="${p.id}" ${selected} data-price="${p.price}">${p.name} - Q${p.price}</option>`;
        });

        row.innerHTML = `
            <td>
                <select name="products[]" class="form-select product-select" onchange="updatePrice(this)" required>
                    ${options}
                </select>
            </td>
            <td>
                <input type="number" name="quantities[]" class="form-control text-center" value="${preQty}" min="1" required>
            </td>
            <td>
                <input type="number" step="0.01" name="prices[]" class="form-control price-input" placeholder="0.00" required>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="this.closest('tr').remove()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
        
        // Si ya ven铆a seleccionado, actualizamos el precio visual
        if(preSelectedId) {
            const select = row.querySelector('.product-select');
            updatePrice(select);
        }
    };

    window.updatePrice = function(selectInfo) {
        const price = selectInfo.options[selectInfo.selectedIndex].getAttribute('data-price');
        const row = selectInfo.closest('tr');
        const priceInput = row.querySelector('.price-input');
        if(price) priceInput.value = price;
    };

    // Iniciar con una fila vac铆a
    document.addEventListener('DOMContentLoaded', () => addRow());


    // --- 2. LGICA DE IA (VENTAS) ---
    document.addEventListener('DOMContentLoaded', function() {
        const btnMagic = document.getElementById('btnMagic');
        const aiPrompt = document.getElementById('aiPrompt');
        const aiImageInput = document.getElementById('aiImage');
        const fieldClient = document.getElementById('id_client');
        const fieldObs = document.getElementById('id_observation');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        // Mostrar nombre de archivo
        aiImageInput.addEventListener('change', function() {
            if(this.files[0]) {
                fileNameDisplay.textContent = " " + this.files[0].name;
                aiPrompt.placeholder = "隆Listo para analizar!";
                aiPrompt.disabled = true;
            }
        });

        if(btnMagic) {
            btnMagic.addEventListener('click', async () => {
                const originalText = btnMagic.innerHTML;
                btnMagic.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Pensando...';
                btnMagic.disabled = true;

                try {
                    let response;
                    const formData = new FormData();

                    // A. MODO IMAGEN (WhatsApp, Correo, Foto)
                    if (aiImageInput.files.length > 0) {
                        formData.append('image', aiImageInput.files[0]);
                        formData.append('context', 'COTIZACION'); // <--- Contexto Clave
                        response = await fetch('/api/ai-magic/', { method: 'POST', body: formData });
                    
                    // B. MODO TEXTO
                    } else {
                        const texto = aiPrompt.value;
                        if(!texto) throw new Error("Escriba el pedido o suba una imagen.");
                        // Usamos un truco simple: enviamos el texto como prompt JSON normal
                        // La IA de texto actual es b谩sica, pero servir谩 para probar conexi贸n
                         response = await fetch('/api/ai-magic/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: texto })
                        });
                    }

                    const json = await response.json();

                    if(json.status === 'ok') {
                        const data = json.data;
                        console.log("IA Ventas:", data);

                        // 1. BUSCAR CLIENTE
                        if(data.cliente && fieldClient) {
                            let encontrado = false;
                            const busqueda = data.cliente.toLowerCase();
                            
                            for (let i = 0; i < fieldClient.options.length; i++) {
                                const optText = fieldClient.options[i].text.toLowerCase();
                                if (optText.includes(busqueda) || busqueda.includes(optText)) {
                                    fieldClient.selectedIndex = i;
                                    encontrado = true;
                                    break;
                                }
                            }
                            if(!encontrado) {
                                alert(`锔 Cliente IA: "${data.cliente}". No lo encontr茅, verifica la lista.`);
                            }
                        }

                        // 2. LLENAR OBSERVACIONES (Lo que pidi贸)
                        if(data.productos && Array.isArray(data.productos)) {
                            const pedidoTexto = data.productos.join(", ");
                            if(fieldObs) {
                                fieldObs.value = "Pedido detectado: " + pedidoTexto + ".\n" + fieldObs.value;
                            }
                        } else if (data.description) {
                             if(fieldObs) fieldObs.value = data.description;
                        }

                        // 3. EXTRAS
                        if(data.observaciones && fieldObs) {
                            fieldObs.value += "\nNota del cliente: " + data.observaciones;
                        }

                    } else {
                        alert("Algo fall贸: " + (json.message || "Error desconocido"));
                    }

                } catch (e) {
                    console.error(e);
                    alert("Error: " + e.message);
                }

                btnMagic.innerHTML = originalText;
                btnMagic.disabled = false;
            });
        }
    });
</script>
{% endblock %}