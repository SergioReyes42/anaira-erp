{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow border-0">
                
                <div class="card-header text-white {% if tipo == 'IN' %}bg-success{% else %}bg-danger{% endif %}">
                    <h4 class="mb-0">
                        {% if tipo == 'IN' %}
                            <i class="bi bi-arrow-down-circle"></i> Registrar Ingreso / Depósito
                        {% else %}
                            <i class="bi bi-arrow-up-circle"></i> Registrar Egreso / Cheque
                        {% endif %}
                    </h4>
                </div>

                <div class="card-body bg-light">
                    
                    <div class="card border-primary mb-4 shadow-sm">
                        <div class="card-body bg-soft-primary p-3">
                            <label class="form-label fw-bold text-primary mb-2">
                                <i class="bi bi-stars"></i> Asistente IA (Gemini)
                            </label>
                            <div class="input-group">
                                <input type="file" id="aiImage" class="d-none" accept="image/*">
                                <button class="btn btn-outline-primary" type="button" onclick="document.getElementById('aiImage').click()">
                                    <i class="bi bi-camera-fill"></i> Subir Foto
                                </button>
                                
                                <input type="text" id="aiPrompt" class="form-control" 
                                       placeholder="Escriba O suba una foto del cheque/boleta...">
                                
                                <button class="btn btn-primary" type="button" id="btnMagic">
                                    <i class="bi bi-lightning-fill"></i> Analizar
                                </button>
                            </div>
                            <small id="fileNameDisplay" class="text-muted ms-2"></small>
                        </div>
                    </div>

                    <form method="post" class="bg-white p-4 rounded shadow-sm" id="transactionForm">
                        {% csrf_token %}

                        {% if form.errors %}
                            <div class="alert alert-danger">
                                <strong>¡Atención! No se pudo guardar:</strong>
                                <ul>
                                {% for field in form %}
                                    {% for error in field.errors %}
                                        <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold">Cuenta Bancaria Afectada</label>
                            {{ form.account }}
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Fecha</label>
                                {{ form.date }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Referencia (No. Cheque/Boleta)</label>
                                {{ form.reference }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Descripción / Concepto</label>
                            {{ form.description }}
                        </div>

                        <div class="row mb-4 align-items-end">
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-success">Monto (Q)</label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text">Q</span>
                                    <input type="text" id="montoVisual" class="form-control fw-bold fs-4" placeholder="0.00" required>
                                    <input type="hidden" name="amount" id="montoReal">
                                </div>
                                <small class="text-muted">Escriba el número, el sistema pone las comas.</small>
                            </div>
                        </div>

                        <input type="hidden" name="movement_type" value="{{ tipo }}">
                        <hr>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'bank_list' %}" class="btn btn-outline-secondary">Cancelar</a>
                            <button type="submit" class="btn {% if tipo == 'IN' %}btn-success{% else %}btn-danger{% endif %} btn-lg px-5">
                                <i class="bi bi-save"></i> Procesar Transacción
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. VARIABLES ---
        const visualInput = document.getElementById('montoVisual');
        const realInput = document.getElementById('montoReal');
        const btnMagic = document.getElementById('btnMagic');
        const aiPrompt = document.getElementById('aiPrompt');
        const aiImageInput = document.getElementById('aiImage');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        // --- 2. LÓGICA DE COMAS ---
        const formatNumber = (n) => {
            let val = n.replace(/\D/g, "").replace(/^0+/, "");
            if (val === "") return "";
            if (val.length === 1) return "0.0" + val;
            if (val.length === 2) return "0." + val;
            let main = val.substring(0, val.length - 2);
            let cents = val.substring(val.length - 2);
            return main.replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "." + cents;
        };

        visualInput.addEventListener('input', (e) => {
            let formatted = formatNumber(e.target.value);
            e.target.value = formatted;
            realInput.value = formatted.replace(/,/g, "");
        });

        // Asegurar valor al enviar
        document.getElementById('transactionForm').addEventListener('submit', (e) => {
            if(!realInput.value && visualInput.value) {
                realInput.value = visualInput.value.replace(/,/g, "");
            }
        });

        // --- 3. LÓGICA IA (HÍBRIDA) ---
        
        // Mostrar nombre archivo
        aiImageInput.addEventListener('change', function() {
            if(this.files && this.files[0]) {
                fileNameDisplay.textContent = "Imagen seleccionada: " + this.files[0].name;
                aiPrompt.placeholder = "¡Imagen lista! Presione Analizar ->";
                aiPrompt.disabled = true;
            }
        });

        if(btnMagic){
            btnMagic.addEventListener('click', async () => {
                const originalIcon = btnMagic.innerHTML;
                btnMagic.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Leyendo...';
                btnMagic.disabled = true;

                try {
                    let response;
                    
                    // A. ESCENARIO IMAGEN
                    if (aiImageInput.files.length > 0) {
                        const formData = new FormData();
                        formData.append('image', aiImageInput.files[0]);
                        const tipoActual = document.querySelector('.bg-danger') ? 'OUT' : 'IN';
                        formData.append('context', tipoActual);

                        response = await fetch('/api/ai-magic/', {
                            method: 'POST',
                            body: formData
                        });

                    // B. ESCENARIO TEXTO
                    } else {
                        const texto = aiPrompt.value;
                        if(!texto) { alert("Escriba algo o suba una foto"); throw new Error("Vacio"); }
                        
                        response = await fetch('/api/ai-magic/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: texto })
                        });
                    }
                    
                    const json = await response.json();
                    
                    if(json.status === 'ok') {
                        const data = json.data;
                        
                        // Mapeo Inteligente de campos
                        if(data.description) document.getElementById('id_description').value = data.description;
                        if(data.fecha) document.getElementById('id_date').value = data.fecha;
                        if(data.date) document.getElementById('id_date').value = data.date;
                        
                        // Referencias varias
                        const ref = data.referencia || data.no_boleta || data.numero_cheque || data.serie;
                        if(ref) document.getElementById('id_reference').value = ref;

                        // Monto
                        let montoFinal = data.amount || data.monto || data.total;
                        if(montoFinal) {
                            montoFinal = montoFinal.toString().replace(/,/g, ""); 
                            visualInput.value = montoFinal;
                            visualInput.dispatchEvent(new Event('input')); 
                        }
                    } else {
                        alert("Error IA: " + (json.message || "Desconocido"));
                    }

                } catch (error) {
                    if (error.message !== "Vacio") {
                        console.error(error);
                        alert('Error al conectar con el cerebro.');
                    }
                }

                btnMagic.innerHTML = originalIcon;
                btnMagic.disabled = false;
            });
        }
    });
</script>
{% endblock %}