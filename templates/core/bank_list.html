{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-dark"><i class="bi bi-bank2"></i> Tesorería y Bancos</h3>
        <a href="{% url 'bank_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Nueva Cuenta
        </a>
    </div>

    <div class="row">
        {% for banco in bancos %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card shadow h-100 border-0">
                <div class="card-header bg-dark text-white d-flex justify-content-between">
                    <span class="fw-bold">{{ banco.bank_name }}</span>
                    <i class="bi bi-wallet2"></i>
                </div>
                
                <div class="card-body text-center">
                    <h6 class="text-muted small">{{ banco.account_number }} ({{ banco.currency }})</h6>
                    
                    <h2 class="display-6 fw-bold {% if banco.current_balance < 0 %}text-danger{% else %}text-success{% endif %} my-3">
                        Q {{ banco.current_balance|floatformat:2 }}
                    </h2>
                    
                    <div class="d-grid gap-2">
                        <div class="btn-group">
                            <a href="{% url 'bank_transaction_create' %}?type=IN&account={{ banco.id }}" class="btn btn-success btn-sm">
                                <i class="bi bi-arrow-down"></i> Depósito
                            </a>
                            <a href="{% url 'bank_transaction_create' %}?type=OUT&account={{ banco.id }}" class="btn btn-danger btn-sm">
                                <i class="bi bi-arrow-up"></i> Cheque/Retiro
                            </a>
                        </div>
                        
                        <button class="btn btn-outline-dark btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#historial{{ banco.id }}">
                            Ver Movimientos <i class="bi bi-chevron-down"></i>
                        </button>
                    </div>
                </div>

                <div class="collapse" id="historial{{ banco.id }}">
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between mb-2">
                            <small class="fw-bold">Últimos 5 movimientos</small>
                            <a href="{% url 'recalcular_saldo' banco.id %}" class="badge bg-warning text-dark text-decoration-none" title="Si el saldo no cuadra, presione aquí">
                                <i class="bi bi-arrow-repeat"></i> Recalcular Saldo
                            </a>
                        </div>

                        <ul class="list-group list-group-flush small">
                            {% for t in banco.banktransaction_set.all|slice:":5" %} 
                            <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                                <div>
                                    <span class="d-block fw-bold">{{ t.date|date:"d/m" }} - {{ t.description|truncatechars:20 }}</span>
                                    <span class="text-muted" style="font-size: 0.75rem;">Ref: {{ t.reference }}</span>
                                </div>
                                <div class="text-end">
                                    <span class="fw-bold {% if t.movement_type == 'IN' %}text-success{% else %}text-danger{% endif %}">
                                        {% if t.movement_type == 'OUT' %}-{% endif %}Q{{ t.amount }}
                                    </span>
                                    <a href="{% url 'delete_transaction' t.id %}" class="text-danger ms-2" onclick="return confirm('¿Eliminar transacción? El saldo se ajustará.');">
                                        <i class="bi bi-x-circle-fill"></i>
                                    </a>
                                </div>
                            </li>
                            {% empty %}
                            <li class="list-group-item text-center text-muted">Sin movimientos recientes</li>
                            {% endfor %}
                        </ul>
                        
                        <div class="text-center mt-3 pb-2">
                             <a href="{% url 'bank_statement' banco.id %}" class="btn btn-sm btn-outline-primary fw-bold w-100">
                                <i class="bi bi-journal-text"></i> Ver Estado de Cuenta Completo
                             </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-center mt-5">
            <h4 class="text-muted">No hay cuentas bancarias registradas.</h4>
            <a href="{% url 'bank_create' %}" class="btn btn-primary mt-3">Crear Primera Cuenta</a>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}