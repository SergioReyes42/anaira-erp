{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow border-danger"> <div class="card-header bg-danger text-white">
            <h3 class="mb-0"><i class="bi bi-box-seam"></i> Ingreso de Mercader铆a (Compra)</h3>
        </div>
        <div class="card-body">
            <form method="post">
                <div class="card border-primary mb-4 shadow-sm">
    <div class="card-header bg-soft-primary py-2">
        <h6 class="mb-0 text-primary fw-bold"><i class="bi bi-robot"></i> Lector de Facturas IA</h6>
    </div>
    <div class="card-body p-3">
        <div class="input-group">
            <input type="file" id="aiImage" class="d-none" accept="image/*">
            
            <button class="btn btn-outline-primary" type="button" onclick="document.getElementById('aiImage').click()" title="Subir foto de factura">
                <i class="bi bi-camera-fill"></i> Foto
            </button>
            
            <input type="text" id="aiPrompt" class="form-control" 
                   placeholder="Suba una foto o escriba: 'Compra de toners en Office Depot por Q450'">
            
            <button class="btn btn-primary" type="button" id="btnMagic">
                <i class="bi bi-magic"></i> Analizar
            </button>
        </div>
        <div class="d-flex justify-content-between mt-2">
            <small id="fileNameDisplay" class="text-muted fst-italic"></small>
            <small class="text-muted"><i class="bi bi-info-circle"></i> Detecta: Proveedor, NIT, Fecha, Serie y Total.</small>
        </div>
    </div>
</div>
                {% csrf_token %}
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Proveedor:</label>
                        <select name="provider" class="form-select" required>
                            <option value="">-- Seleccione Proveedor --</option>
                            {% for p in providers %}
                                <option value="{{ p.id }}">{{ p.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <a href="/admin/core/provider/add/" target="_blank">Registrar nuevo proveedor</a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">No. Factura / Referencia:</label>
                        <input type="text" name="reference" class="form-control" placeholder="Ej: FAC-2026-001" required>
                    </div>
                </div>

                <hr>

                <h5 class="mb-3">Detalle de Ingreso</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Producto</th>
                                <th width="150">Cantidad</th>
                                <th width="150">Costo Unitario (Q)</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody id="productsBody"></tbody>
                    </table>
                </div>

                <button type="button" class="btn btn-outline-danger btn-sm mb-3" onclick="addRow()">
                    <i class="bi bi-plus-circle"></i> Agregar Fila
                </button>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-danger btn-lg">
                        <i class="bi bi-save"></i> Guardar Compra y Sumar Stock
                    </button>
                    <a href="{% url 'purchase_list' %}" class="btn btn-secondary">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="django-data" style="display:none;">
    {% for p in products %}
    <span class="product-data" data-id="{{ p.id }}" data-name="{{ p.name }}"></span>
    {% endfor %}
</div>

<script>
    const productsList = [];
    document.querySelectorAll('#django-data .product-data').forEach(item => {
        productsList.push({ id: item.dataset.id, name: item.dataset.name });
    });

    function addRow() {
        const tbody = document.getElementById('productsBody');
        const row = document.createElement('tr');
        
        let optionsHtml = '<option value="">-- Producto --</option>';
        productsList.forEach(p => {
            optionsHtml += `<option value="${p.id}">${p.name}</option>`;
        });

        row.innerHTML = `
            <td>
                <select name="products[]" class="form-select" required>${optionsHtml}</select>
            </td>
            <td>
                <input type="number" name="quantities[]" class="form-control" value="1" min="1" required>
            </td>
            <td>
                <input type="number" step="0.01" name="costs[]" class="form-control" placeholder="0.00" required>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()"><i class="bi bi-trash"></i></button>
            </td>
        `;
        tbody.appendChild(row);
    }
    window.onload = addRow;
</script>
{% endblock %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- VARIABLES ---
        const btnMagic = document.getElementById('btnMagic');
        const aiPrompt = document.getElementById('aiPrompt');
        const aiImageInput = document.getElementById('aiImage');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        // --- CAMPOS DEL FORMULARIO (MODIFIQUE LOS ID SI SON DIFERENTES) ---
        // Django por defecto usa id_nombrecampo
        const fieldProvider = document.getElementById('id_provider'); // Select de proveedor
        const fieldDate = document.getElementById('id_date');         // Fecha
        const fieldRef = document.getElementById('id_invoice_number'); // No. Factura/Serie
        const fieldTotal = document.getElementById('id_total');       // Total
        const fieldObs = document.getElementById('id_observation');   // Observaciones (opcional)

        // 1. Mostrar nombre de archivo al seleccionar
        aiImageInput.addEventListener('change', function() {
            if(this.files && this.files[0]) {
                fileNameDisplay.textContent = " Imagen lista: " + this.files[0].name;
                aiPrompt.placeholder = "隆Presione Analizar para procesar la factura!";
                aiPrompt.disabled = true;
            }
        });

        // 2. LOGICA DEL BOTN MGICO
        if(btnMagic){
            btnMagic.addEventListener('click', async () => {
                // UI: Bloquear y mostrar spinner
                const originalContent = btnMagic.innerHTML;
                btnMagic.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';
                btnMagic.disabled = true;

                try {
                    let response;
                    const formData = new FormData();

                    // A. MODO IMAGEN (Prioridad)
                    if (aiImageInput.files.length > 0) {
                        formData.append('image', aiImageInput.files[0]);
                        formData.append('context', 'GASTO'); // <--- CLAVE: Le decimos a la IA que es un GASTO
                        
                        response = await fetch('/api/ai-magic/', { method: 'POST', body: formData });

                    // B. MODO TEXTO
                    } else {
                        const texto = aiPrompt.value;
                        if(!texto) { throw new Error("Por favor suba una foto o escriba algo."); }
                        
                        // Para texto usamos el mismo endpoint pero JSON
                        response = await fetch('/api/ai-magic/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: texto }) 
                            // Nota: El cerebro de texto actual es b谩sico, el fuerte es la IMAGEN
                        });
                    }

                    const json = await response.json();

                    if(json.status === 'ok') {
                        const data = json.data;
                        console.log("Datos IA:", data); // Para depurar

                        // --- MAPEO DE DATOS ---

                        // 1. Fecha
                        if(data.fecha && fieldDate) fieldDate.value = data.fecha;
                        
                        // 2. Serie / N煤mero de Factura
                        if(data.serie && fieldRef) fieldRef.value = data.serie;
                        if(data.referencia && fieldRef) fieldRef.value = data.referencia;

                        // 3. Total
                        if((data.total || data.amount) && fieldTotal) {
                            let monto = (data.total || data.amount).toString().replace(/,/g, "");
                            fieldTotal.value = monto;
                        }

                        // 4. Proveedor (L贸gica Dif铆cil: Dropdown)
                        // Intentamos buscar el texto del proveedor en el select
                        if(data.proveedor && fieldProvider) {
                            let encontrado = false;
                            const busqueda = data.proveedor.toLowerCase();
                            
                            // Recorrer opciones para ver si alguna coincide
                            for (let i = 0; i < fieldProvider.options.length; i++) {
                                const optText = fieldProvider.options[i].text.toLowerCase();
                                if (optText.includes(busqueda) || busqueda.includes(optText)) {
                                    fieldProvider.selectedIndex = i;
                                    encontrado = true;
                                    break;
                                }
                            }
                            // Si no lo encuentra, lo ponemos en observaciones
                            if(!encontrado && fieldObs) {
                                fieldObs.value = `Proveedor detectado por IA: ${data.proveedor} (NIT: ${data.nit || 'N/A'}). ` + fieldObs.value;
                                alert(`锔 La IA detect贸 al proveedor "${data.proveedor}", pero no lo tienes registrado en tu lista. Lo puse en observaciones.`);
                            }
                        }
                        
                        // 5. Extras en observaci贸n
                        if(data.nit && fieldObs && !fieldObs.value.includes(data.nit)) {
                            fieldObs.value += ` NIT: ${data.nit}`;
                        }

                    } else {
                        alert("Error IA: " + json.message);
                    }

                } catch (error) {
                    console.error(error);
                    alert('Error: ' + error.message);
                }

                // Restaurar bot贸n
                btnMagic.innerHTML = originalContent;
                btnMagic.disabled = false;
            });
        }
    });
</script>