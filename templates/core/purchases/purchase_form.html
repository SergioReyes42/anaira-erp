{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow border-danger"> 
        <div class="card-header bg-danger text-white">
            <h3 class="mb-0"><i class="bi bi-box-seam"></i> Ingreso de Mercader√≠a (Compra)</h3>
        </div>
        <div class="card-body">
            
            <form method="post" id="purchaseForm">
                {% csrf_token %}

                <div class="card border-primary mb-4 shadow-sm">
                    <div class="card-header bg-soft-primary py-2">
                        <h6 class="mb-0 text-primary fw-bold"><i class="bi bi-robot"></i> Lector de Facturas IA</h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="input-group">
                            <input type="file" id="aiImage" class="d-none" accept="image/*">
                            
                            <button class="btn btn-outline-primary" type="button" onclick="document.getElementById('aiImage').click()" title="Subir foto de factura">
                                <i class="bi bi-camera-fill"></i> Foto
                            </button>
                            
                            <input type="text" id="aiPrompt" class="form-control" 
                                   placeholder="Suba una foto o escriba: 'Compra de toners en Office Depot por Q450'">
                            
                            <button class="btn btn-primary" type="button" id="btnMagic">
                                <i class="bi bi-magic"></i> Analizar
                            </button>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <small id="fileNameDisplay" class="text-muted fst-italic"></small>
                            <small class="text-muted"><i class="bi bi-info-circle"></i> Detecta: Proveedor, NIT, Fecha, Serie y Total.</small>
                        </div>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Proveedor:</label>
                        <select name="provider" id="id_provider" class="form-select" required>
                            <option value="">-- Seleccione Proveedor --</option>
                            {% for p in providers %}
                                <option value="{{ p.id }}">{{ p.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <a href="/admin/core/provider/add/" target="_blank">Registrar nuevo proveedor</a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">No. Factura / Referencia:</label>
                        <input type="text" name="reference" id="id_invoice_number" class="form-control" placeholder="Ej: FAC-2026-001" required>
                    </div>
                </div>

                <hr>

                <h5 class="mb-3">Detalle de Ingreso</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Producto</th>
                                <th width="150">Cantidad</th>
                                <th width="150">Costo Unitario (Q)</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody id="productsBody"></tbody>
                    </table>
                </div>

                <button type="button" class="btn btn-outline-danger btn-sm mb-3" onclick="addRow()">
                    <i class="bi bi-plus-circle"></i> Agregar Fila
                </button>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-danger btn-lg">
                        <i class="bi bi-save"></i> Guardar Compra y Sumar Stock
                    </button>
                    <a href="{% url 'purchase_list' %}" class="btn btn-secondary">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="django-data" style="display:none;">
    {% for p in products %}
    <span class="product-data" data-id="{{ p.id }}" data-name="{{ p.name }}"></span>
    {% endfor %}
</div>

<script>
    // --- 1. L√ìGICA DE FILAS (PRODUCTOS) ---
    const productsList = [];
    document.querySelectorAll('#django-data .product-data').forEach(item => {
        productsList.push({ id: item.dataset.id, name: item.dataset.name });
    });

    // Definimos addRow globalmente para que el bot√≥n onclick funcione
    window.addRow = function() {
        const tbody = document.getElementById('productsBody');
        const row = document.createElement('tr');
        
        let optionsHtml = '<option value="">-- Producto --</option>';
        productsList.forEach(p => {
            optionsHtml += `<option value="${p.id}">${p.name}</option>`;
        });

        row.innerHTML = `
            <td>
                <select name="products[]" class="form-select" required>${optionsHtml}</select>
            </td>
            <td>
                <input type="number" name="quantities[]" class="form-control" value="1" min="1" required>
            </td>
            <td>
                <input type="number" step="0.01" name="costs[]" class="form-control" placeholder="0.00" required>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()"><i class="bi bi-trash"></i></button>
            </td>
        `;
        tbody.appendChild(row);
    }

    // --- 2. L√ìGICA DE IA (GEMINI) ---
    document.addEventListener('DOMContentLoaded', function() {
        // Iniciamos con una fila vac√≠a
        window.addRow();

        const btnMagic = document.getElementById('btnMagic');
        const aiPrompt = document.getElementById('aiPrompt');
        const aiImageInput = document.getElementById('aiImage');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        // Campos
        const fieldProvider = document.getElementById('id_provider');
        const fieldRef = document.getElementById('id_invoice_number');
        const fieldTotal = document.getElementById('id_total'); // Si existiera
        const fieldObs = document.getElementById('id_observation'); // Si existiera

        // Mostrar nombre archivo
        aiImageInput.addEventListener('change', function() {
            if(this.files && this.files[0]) {
                fileNameDisplay.textContent = "üì∏ Imagen lista: " + this.files[0].name;
                aiPrompt.placeholder = "¬°Presione Analizar!";
                aiPrompt.disabled = true;
            }
        });

        if(btnMagic){
            btnMagic.addEventListener('click', async () => {
                const originalContent = btnMagic.innerHTML;
                btnMagic.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';
                btnMagic.disabled = true;

                try {
                    let response;
                    const formData = new FormData();

                    // A. IMAGEN
                    if (aiImageInput.files.length > 0) {
                        formData.append('image', aiImageInput.files[0]);
                        formData.append('context', 'GASTO');
                        response = await fetch('/api/ai-magic/', { method: 'POST', body: formData });
                    
                    // B. TEXTO
                    } else {
                        const texto = aiPrompt.value;
                        if(!texto) throw new Error("Suba foto o escriba algo.");
                        response = await fetch('/api/ai-magic/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: texto })
                        });
                    }

                    const json = await response.json();

                    if(json.status === 'ok') {
                        const data = json.data;
                        console.log("IA Data:", data);

                        // Llenar Referencia / Factura
                        if((data.serie || data.referencia) && fieldRef) {
                            fieldRef.value = data.serie || data.referencia;
                        }

                        // Llenar Total (Si hubiera campo)
                        if((data.total || data.amount) && fieldTotal) {
                            fieldTotal.value = (data.total || data.amount).toString().replace(/,/g, "");
                        }

                        // Llenar Proveedor (B√∫squeda en Select)
                        if(data.proveedor && fieldProvider) {
                            let encontrado = false;
                            const busqueda = data.proveedor.toLowerCase();
                            for (let i = 0; i < fieldProvider.options.length; i++) {
                                const optText = fieldProvider.options[i].text.toLowerCase();
                                if (optText.includes(busqueda) || busqueda.includes(optText)) {
                                    fieldProvider.selectedIndex = i;
                                    encontrado = true;
                                    break;
                                }
                            }
                            if(!encontrado) {
                                alert(`‚ö†Ô∏è Proveedor detectado: "${data.proveedor}", pero no est√° en la lista. Registrelo.`);
                            }
                        }

                    } else {
                        alert("Error IA: " + (json.message || "Desconocido"));
                    }

                } catch (error) {
                    console.error(error);
                    alert('Error: ' + error.message);
                }

                btnMagic.innerHTML = originalContent;
                btnMagic.disabled = false;
            });
        }
    });
</script>
{% endblock %}