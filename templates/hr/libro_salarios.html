{% extends 'base.html' %}

{% block content %}

<style>
    #hoja-legal { display: none; }

    @media print {
        /* Ocultar interfaz del ERP */
        body * { visibility: hidden; }
        .no-print, .sidebar, header, footer, .btn, .card { display: none !important; }

        /* Configuración de página HORIZONTAL */
        @page {
            size: landscape; /* Hoja acostada */
            margin: 1cm;
        }

        body {
            background: white;
            font-family: 'Arial', sans-serif;
            font-size: 10pt;
            color: black;
        }

        #hoja-legal, #hoja-legal * {
            visibility: visible;
        }

        #hoja-legal {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }

        /* Tabla densa para que quepan todas las columnas */
        .tabla-libro {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
        }
        .tabla-libro th, .tabla-libro td {
            border: 1px solid black;
            padding: 4px;
            text-align: center;
        }
        .tabla-libro th {
            background-color: #f0f0f0 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .text-left { text-align: left !important; }
        .text-right { text-align: right !important; }
    }
</style>

<div class="container-fluid no-print">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="text-primary fw-bold"><i class="bi bi-journal-bookmark-fill"></i> Libro de Salarios</h3>
            <p class="text-muted">Formato autorizado por el Ministerio de Trabajo y Previsión Social</p>
        </div>
        <button onclick="window.print()" class="btn btn-dark btn-lg">
            <i class="bi bi-printer"></i> Imprimir Folio
        </button>
    </div>

    <div class="card shadow border-0">
        <div class="card-body">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> <strong>Nota:</strong> Esta es una vista previa de la última nómina generada. Para ver el formato legal oficial, presione el botón "Imprimir Folio".
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Empleado</th>
                            <th>Puesto</th>
                            <th>Días Lab.</th>
                            <th>Salario Base</th>
                            <th>Bonificación</th>
                            <th>Líquido</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in detalles %}
                        <tr>
                            <td>{{ item.employee.first_name }} {{ item.employee.last_name }}</td>
                            <td>{{ item.employee.position }}</td>
                            <td>30</td>
                            <td>Q {{ item.employee.base_salary }}</td>
                            <td>Q {{ item.employee.bonus }}</td>
                            <td><span class="badge bg-success">Q {{ item.net_salary }}</span></td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="text-center">No hay nóminas generadas. Vaya a "Generar Nómina" primero.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="hoja-legal">
    <table style="width: 100%; margin-bottom: 10px;">
        <tr>
            <td style="width: 20%; vertical-align: middle;">
                {% if company.logo %}
                    <img src="{{ company.logo.url }}" style="max-height: 60px;">
                {% endif %}
            </td>
            <td style="text-align: center;">
                <h3 style="margin: 0;">LIBRO DE SALARIOS</h3>
                <h4 style="margin: 0;">{{ company.name }}</h4>
                <small>NIT: {{ company.nit }} | Folio No. _______</small>
            </td>
            <td style="width: 20%; text-align: right;">
                <small>Periodo: {% now "F Y" %}</small>
            </td>
        </tr>
    </table>

    <table class="tabla-libro">
        <thead>
            <tr>
                <th rowspan="2">No.</th>
                <th rowspan="2" style="width: 200px;">Nombre Completo</th>
                <th rowspan="2">Días<br>Lab.</th>
                <th colspan="4">DEVENGADO</th>
                <th colspan="3">DEDUCCIONES</th>
                <th rowspan="2">Líquido a<br>Recibir</th>
                <th rowspan="2" style="width: 100px;">Firma</th>
            </tr>
            <tr>
                <th>Ordinario</th>
                <th>Extraord.</th>
                <th>Séptimos</th>
                <th>Bonific.</th>
                <th>IGSS</th>
                <th>ISR</th>
                <th>Otros</th>
            </tr>
        </thead>
        <tbody>
            {% for item in detalles %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td class="text-left">{{ item.employee.last_name }}, {{ item.employee.first_name }}</td>
                <td>30</td>
                
                <td class="text-right">{{ item.employee.base_salary }}</td>
                <td class="text-right">0.00</td>
                <td class="text-right">0.00</td>
                <td class="text-right">{{ item.employee.bonus }}</td>
                
                <td class="text-right">{{ item.igss_deduction }}</td> 
                <td class="text-right">{{ item.isr_deduction }}</td>
                <td class="text-right">{{ item.advances }}</td>
                
                <td class="text-right fw-bold">{{ item.net_salary }}</td>
                <td></td>
            </tr>
            {% endfor %}
            
            {% if detalles %}
            <tr style="font-weight: bold; background-color: #f0f0f0;">
                <td colspan="3" class="text-right">TOTALES:</td>
                <td class="text-right">Q {{ totales.devengado|floatformat:2 }}</td> <td class="text-right">0.00</td>
                <td class="text-right">0.00</td>
                <td class="text-right">Incluido</td>
                
                <td class="text-right">Q {{ totales.igss|floatformat:2 }}</td>
                <td class="text-right">Q {{ totales.isr|floatformat:2 }}</td>
                <td class="text-right">0.00</td>
                
                <td class="text-right">Q {{ totales.liquido|floatformat:2 }}</td>
                <td></td>
            </tr>
            {% endif %}
        </tbody>
    </table>

    <div style="margin-top: 50px; width: 100%; text-align: center;">
        <table style="width: 100%">
            <tr>
                <td>__________________________<br>Contador Registrado</td>
                <td>__________________________<br>Representante Legal</td>
                <td>__________________________<br>Inspector de Trabajo (Sello)</td>
            </tr>
        </table>
    </div>
</div>

{% endblock %}