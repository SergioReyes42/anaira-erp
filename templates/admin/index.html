{% extends "admin/index.html" %}
{# Cargamos log (para actividad) y dashboard_extras (para usuarios) #}
{% load static i18n log dashboard_extras %}

{% block extrahead %}
    {{ block.super }}
    <style>
        /* --- ESTILOS DEL DASHBOARD PRINCIPAL --- */
        .ns-dashboard-banner {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .ns-footer {
            font-size: 0.8rem;
            color: #666;
        }

        /* --- ESTILOS DEL WIDGET FLOTANTE (Esquina Inferior Derecha) --- */
        .online-widget-container {
            position: fixed;
            bottom: 0;
            right: 20px;
            width: 280px;
            background: #fff;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            z-index: 9999; /* Para que quede siempre encima */
            border: 1px solid #dcdcdc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden;
        }

        .online-widget-header {
            background: #0A2342; /* Azul Corporativo */
            color: #fff;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .online-widget-body {
            max-height: 300px;
            overflow-y: auto;
            background: #f9f9f9;
        }

        .online-user-row {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            background: #fff;
            transition: background 0.2s;
        }
        .online-user-row:hover {
            background: #f0f8ff;
        }

        .status-dot {
            height: 10px;
            width: 10px;
            background-color: #28a745; /* Verde Activo */
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        /* --- ESTILOS DE BITACORA --- */
        .activity-dashboard { margin-bottom: 25px; background: #fff; border: 1px solid #ddd; border-radius: 8px; }
        .activity-header { background: #f1f3f5; padding: 12px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .ns-table { width: 100%; border-collapse: collapse; }
        .ns-table th { text-align: left; padding: 10px 20px; background: #fafafa; border-bottom: 2px solid #eee; font-size: 11px; text-transform: uppercase; color: #666; }
        .ns-table td { padding: 12px 20px; border-bottom: 1px solid #eee; font-size: 13px; vertical-align: middle; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-add { background: #d1e7dd; color: #0f5132; }
        .badge-change { background: #fff3cd; color: #664d03; }
        .badge-delete { background: #f8d7da; color: #842029; }
    </style>
{% endblock %}

{% block content %}
    <div class="ns-dashboard-banner" style="background: linear-gradient(90deg, #0B5ED7 0%, #0A2342 100%); color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
        <h2 style="margin:0; font-weight: 600;">Bienvenido a ANAIRA SYSTEMS</h2>
        <p style="margin:6px 0 0 0; opacity: 0.9;">Panel de control y reporterÃ­a</p>
    </div>

    <div class="activity-dashboard">
        <div class="activity-header">
            <h3 style="margin:0; font-size:14px; font-weight:700; color:#0A2342;">ðŸ“Š BitÃ¡cora de Operaciones</h3>
            <span style="font-size: 11px; color: #666;">Ãšltimos 10 registros</span>
        </div>

        {% get_admin_log 10 as admin_log %}
        
        {% if admin_log %}
            <table class="ns-table">
                <thead>
                    <tr>
                        <th style="width:15%">Hora</th>
                        <th style="width:20%">Usuario</th>
                        <th style="width:15%">AcciÃ³n</th>
                        <th>Objeto</th>
                    </tr>
                </thead>
                <tbody>
                {% for entry in admin_log %}
                    <tr>
                        <td style="color:#666; font-family:monospace;">{{ entry.action_time|date:"H:i" }}</td>
                        <td><strong style="color:#0B5ED7;">{{ entry.user.username|upper }}</strong></td>
                        <td>
                            {% if entry.is_addition %}<span class="badge badge-add">âœš CREÃ“</span>
                            {% elif entry.is_change %}<span class="badge badge-change">âœŽ EDITÃ“</span>
                            {% elif entry.is_deletion %}<span class="badge badge-delete">âœ– BORRÃ“</span>{% endif %}
                        </td>
                        <td>
                            {% if not entry.is_deletion and entry.get_admin_url %}
                                <a href="{{ entry.get_admin_url }}" style="font-weight:600;">{{ entry.object_repr }}</a>
                            {% else %}
                                {{ entry.object_repr }}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div style="padding:20px; text-align:center; color:#777;">Sin actividad reciente.</div>
        {% endif %}
    </div>

    {{ block.super }}

    <div class="online-widget-container">
        <div class="online-widget-header" onclick="toggleWidget()">
            <span>ðŸ‘¥ Usuarios Online</span>
            <span id="widget-toggle-icon">â–¼</span>
        </div>

        <div class="online-widget-body" id="widget-body">
            {% get_online_users as active_users_list %}
            
            {% if active_users_list %}
                {% for user in active_users_list %}
                    <div class="online-user-row">
                        <span class="status-dot"></span>
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:600; font-size:13px; color:#333;">
                                {{ user.username|upper }}
                            </span>
                            <span style="font-size:11px; color:#888;">
                                {% if user.email %}{{ user.email }}{% else %}Conectado{% endif %}
                            </span>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div style="padding:15px; text-align:center; color:#999; font-size:13px;">
                    No hay nadie mÃ¡s.
                </div>
            {% endif %}
        </div>
    </div>

    <div class="text-center" style="margin-top: 30px; padding: 20px 0; border-top: 1px solid #eee;">
        <span class="ns-footer">ANAIRA SYSTEMS &copy; {% now "Y" %}</span>
    </div>
{% endblock %}

{% block extrajs %}
    {{ block.super }}
    <script>
        // PequeÃ±o script para minimizar/maximizar la ventana del chat
        function toggleWidget() {
            var body = document.getElementById('widget-body');
            var icon = document.getElementById('widget-toggle-icon');
            
            if (body.style.display === 'none') {
                body.style.display = 'block';
                icon.innerHTML = 'â–¼';
            } else {
                body.style.display = 'none';
                icon.innerHTML = 'â–²';
            }
        }
    </script>
{% endblock %}