{% extends "admin/index.html" %}
{# Cargamos log (para actividad) y dashboard_extras (para usuarios online) #}
{% load static i18n log dashboard_extras %}

{% block extrahead %}
    {{ block.super }}
    <style>
        .ns-dashboard-banner {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .ns-footer {
            font-size: 0.8rem;
            color: #666;
        }

        /* --- WIDGET USUARIOS ONLINE --- */
        .online-users-panel {
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .online-title {
            font-weight: bold;
            color: #555;
            margin-right: 15px;
            font-size: 13px;
            text-transform: uppercase;
            border-right: 1px solid #eee;
            padding-right: 15px;
        }
        .user-badge {
            display: inline-flex;
            align-items: center;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: #333;
            transition: all 0.3s;
        }
        .user-badge:hover {
            border-color: #b1d5f1;
            background: #eef6fc;
        }
        .status-dot {
            height: 10px;
            width: 10px;
            background-color: #198754; /* Verde Online */
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            box-shadow: 0 0 0 2px rgba(25, 135, 84, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(25, 135, 84, 0); }
            100% { box-shadow: 0 0 0 0 rgba(25, 135, 84, 0); }
        }

        /* --- MONITOR DE ACTIVIDAD --- */
        .activity-dashboard {
            margin-bottom: 25px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .activity-header {
            background: #f1f3f5;
            padding: 12px 20px;
            border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
        }
        .ns-table { width: 100%; border-collapse: collapse; }
        .ns-table th { text-align: left; padding: 10px 20px; background: #fafafa; border-bottom: 2px solid #eee; font-size: 11px; text-transform: uppercase; color: #666; }
        .ns-table td { padding: 12px 20px; border-bottom: 1px solid #eee; font-size: 13px; vertical-align: middle; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-add { background: #d1e7dd; color: #0f5132; }
        .badge-change { background: #fff3cd; color: #664d03; }
        .badge-delete { background: #f8d7da; color: #842029; }
    </style>
{% endblock %}

{% block content %}
    <div class="ns-dashboard-banner" style="background: linear-gradient(90deg, #0B5ED7 0%, #0A2342 100%); color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
        <h2 style="margin:0; font-weight: 600;">Bienvenido a ANAIRA SYSTEMS</h2>
        <p style="margin:6px 0 0 0; opacity: 0.9;">Panel de control y reporterÃ­a</p>
    </div>

    <div class="online-users-panel">
        <span class="online-title">ðŸ‘¥ Usuarios Activos Ahora</span>
        
        {# Llama a la funciÃ³n de Python que creamos #}
        {% get_online_users as active_users_list %}

        {% if active_users_list %}
            {% for user in active_users_list %}
                <div class="user-badge" title="Ãšltima actividad: Reciente">
                    <span class="status-dot"></span>
                    {{ user.username|upper }}
                </div>
            {% endfor %}
        {% else %}
            <span style="color: #999; font-size: 13px; font-style: italic;">
                No hay otros usuarios conectados.
            </span>
        {% endif %}
    </div>

    <div class="activity-dashboard">
        <div class="activity-header">
            <h3 style="margin:0; font-size:14px; font-weight:700; color:#0A2342;">ðŸ“Š BitÃ¡cora de Operaciones</h3>
            <span style="font-size: 11px; color: #666;">Ãšltimos 10 registros</span>
        </div>

        {% get_admin_log 10 as admin_log %}
        
        {% if admin_log %}
            <table class="ns-table">
                <thead>
                    <tr>
                        <th style="width:15%">Hora</th>
                        <th style="width:20%">Usuario</th>
                        <th style="width:15%">AcciÃ³n</th>
                        <th>Objeto</th>
                    </tr>
                </thead>
                <tbody>
                {% for entry in admin_log %}
                    <tr>
                        <td style="color:#666; font-family:monospace;">{{ entry.action_time|date:"H:i" }}</td>
                        <td><strong style="color:#0B5ED7;">{{ entry.user.username|upper }}</strong></td>
                        <td>
                            {% if entry.is_addition %}<span class="badge badge-add">âœš CREÃ“</span>
                            {% elif entry.is_change %}<span class="badge badge-change">âœŽ EDITÃ“</span>
                            {% elif entry.is_deletion %}<span class="badge badge-delete">âœ– BORRÃ“</span>{% endif %}
                        </td>
                        <td>
                            {% if not entry.is_deletion and entry.get_admin_url %}
                                <a href="{{ entry.get_admin_url }}" style="font-weight:600;">{{ entry.object_repr }}</a>
                            {% else %}
                                {{ entry.object_repr }}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div style="padding:20px; text-align:center; color:#777;">Sin actividad reciente.</div>
        {% endif %}
    </div>

    {{ block.super }}

    <div class="text-center" style="margin-top: 30px; padding: 20px 0; border-top: 1px solid #eee;">
        <span class="ns-footer">ANAIRA SYSTEMS &copy; {% now "Y" %}</span>
    </div>
{% endblock %}