{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-dark fw-bold mb-0"><i class="bi bi-file-earmark-text text-primary me-2"></i>Nueva Cotización</h2>
            <p class="text-muted">Genera un presupuesto aislado a tu sucursal actual.</p>
        </div>
        <a href="{% url 'sales:quotation_list' %}" class="btn btn-outline-secondary shadow-sm">
            <i class="bi bi-arrow-left me-1"></i> Volver a Cotizaciones
        </a>
    </div>

    <form method="POST" id="quotationForm" class="needs-validation">
        {% csrf_token %}
        
        <div class="card shadow-sm border-0 border-top border-primary border-4 mb-4">
            <div class="card-header bg-white border-0 pt-4 pb-0">
                <h5 class="fw-bold text-dark"><i class="bi bi-person-badge text-primary me-2"></i>Datos del Cliente y Bodega</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-secondary">Cliente</label>
                        {{ form.client }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-secondary">Bodega de Despacho (Solo tu sucursal)</label>
                        {{ form.warehouse }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold text-secondary">Válida Hasta</label>
                        {{ form.valid_until }}
                    </div>
                    <div class="col-md-8">
                        <label class="form-label fw-bold text-secondary">Condiciones / Notas</label>
                        {{ form.notes }}
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 border-top border-success border-4 mb-4">
            <div class="card-header bg-white border-0 pt-4 pb-2 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold text-dark"><i class="bi bi-cart-plus text-success me-2"></i>Detalle de Productos</h5>
                <button type="button" class="btn btn-sm btn-primary shadow-sm" id="addRowBtn">
                    <i class="bi bi-plus-circle me-1"></i> Agregar Línea
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="productsTable">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4" style="width: 40%;">Producto del Catálogo</th>
                                <th style="width: 12%;">Cantidad</th>
                                <th style="width: 18%;">Precio Unitario (Q)</th>
                                <th style="width: 12%;">Desc. (%)</th>
                                <th style="width: 13%;">Subtotal (Q)</th>
                                <th class="text-center" style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            </tbody>
                        <tfoot class="bg-light fw-bold">
                            <tr>
                                <td colspan="4" class="text-end pe-4 fs-5 text-dark">TOTAL COTIZACIÓN:</td>
                                <td colspan="2" class="ps-3 fs-4 text-primary">Q. <span id="grandTotal">0.00</span></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-success px-5 fw-bold shadow-sm" id="saveBtn">
                <i class="bi bi-send-check-fill me-1"></i> Generar Cotización
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.getElementById('tableBody');
    const addRowBtn = document.getElementById('addRowBtn');
    const grandTotalSpan = document.getElementById('grandTotal');

    const productsOptions = `
        <option value="">-- Seleccione un producto --</option>
        {% for p in products %}
            <option value="{{ p.id }}" data-price="{{ p.sale_price }}">{{ p.sku }} - {{ p.name }} (Q.{{ p.sale_price }})</option>
        {% endfor %}
    `;

    function calculateTotals() {
        let total = 0;
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
            const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const discount = parseFloat(row.querySelector('.discount-input').value) || 0;
            
            // Fórmula: (Cantidad * Precio) - Descuento%
            const subtotal = (qty * price) * (1 - (discount / 100));
            
            row.querySelector('.subtotal-cell').textContent = subtotal.toFixed(2);
            total += subtotal;
        });
        grandTotalSpan.textContent = total.toFixed(2);
    }

    function addRow() {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="ps-4">
                <select name="products[]" class="form-select product-select" required>
                    ${productsOptions}
                </select>
            </td>
            <td>
                <input type="number" name="quantities[]" class="form-control qty-input" min="1" value="1" required>
            </td>
            <td>
                <div class="input-group">
                    <span class="input-group-text bg-light text-muted border-end-0">Q</span>
                    <input type="number" name="prices[]" class="form-control price-input bg-light" step="0.01" min="0" readonly required>
                </div>
            </td>
            <td>
                <div class="input-group">
                    <input type="number" name="discounts[]" class="form-control discount-input border-warning" step="0.01" min="0" max="100" value="0">
                    <span class="input-group-text bg-warning bg-opacity-10">%</span>
                </div>
            </td>
            <td class="fw-bold text-secondary text-end pe-4">
                Q. <span class="subtotal-cell">0.00</span>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger remove-btn" title="Eliminar línea">
                    <i class="bi bi-trash-fill"></i>
                </button>
            </td>
        `;
        tableBody.appendChild(tr);

        const productSelect = tr.querySelector('.product-select');
        const priceInput = tr.querySelector('.price-input');
        const qtyInput = tr.querySelector('.qty-input');
        const discountInput = tr.querySelector('.discount-input');
        const removeBtn = tr.querySelector('.remove-btn');

        productSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if(selectedOption.value) {
                priceInput.value = selectedOption.getAttribute('data-price');
            } else {
                priceInput.value = '';
            }
            calculateTotals();
        });

        qtyInput.addEventListener('input', calculateTotals);
        // Si el usuario intenta hacer trampa y le quita el readonly desde el navegador, igual recalcula
        priceInput.addEventListener('input', calculateTotals); 
        discountInput.addEventListener('input', calculateTotals); 

        removeBtn.addEventListener('click', function() {
            tr.remove();
            calculateTotals();
        });
    }

    addRow();
    addRowBtn.addEventListener('click', addRow);
});
</script>
{% endblock %}