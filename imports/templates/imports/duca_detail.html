{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Resumen de Liquidación - DUCA: <span class="text-primary">{{ duca.duca_number }}</span></h2>
        <a href="{% url 'imports:reception_add' duca.pk %}" class="btn btn-warning fw-bold text-dark ms-2">
            <i class="bi bi-box-seam"></i> Recibir en Bodega
        </a>
        <a href="{% url 'imports:duca_list' %}" class="btn btn-outline-secondary">Volver al listado</a>
    </div>

    <div class="row mb-4">
        <div class="col-md-5"> <div class="card border-primary shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-primary border-bottom pb-2">Datos Internacionales</h5>
                    <p class="mb-1"><strong>Proveedor:</strong> {{ duca.supplier_name }}</p>
                    <p class="mb-1"><strong>Tipo de Cambio:</strong> Q. {{ duca.exchange_rate }}</p>
                    <p class="mb-1"><strong>FOB Total:</strong> ${{ duca.total_fob_usd|floatformat:2 }}</p>
                    <p class="mb-1"><strong>Flete + Seguro:</strong> ${{ duca.freight_usd }} + ${{ duca.insurance_usd }}</p>
                    <h5 class="mt-3 text-danger">CIF Total: ${{ duca.total_cif_usd|floatformat:2 }}</h5>

                    <h6 class="mt-4 text-secondary border-bottom pb-1"><i class="bi bi-file-text"></i> Órdenes Vinculadas</h6>
                    <ul class="list-group list-group-flush mb-2" style="font-size: 0.85rem;">
                        {% for po in duca.purchase_orders.all %}
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-1 bg-transparent border-light">
                                <span><strong>{{ po.po_number }}</strong> <span class="text-muted">({{ po.supplier_name }})</span></span>
                                <span class="badge bg-primary rounded-pill">${{ po.total_amount_usd }}</span>
                            </li>
                        {% empty %}
                            <li class="list-group-item px-0 py-1 bg-transparent text-muted border-0">Ninguna orden vinculada.</li>
                        {% endfor %}
                    </ul>
                    </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-success shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-success border-bottom pb-2">Gastos Locales (GTQ)</h5>
                    <p class="mb-1"><strong>DAI Total (Aranceles):</strong> Q. {{ duca.total_dai_gtq|floatformat:2 }}</p>
                    <p class="mb-1"><strong>Otros Gastos (Aduana):</strong> Q. {{ duca.other_expenses_gtq }}</p>
                    <p class="mb-1 text-muted"><em>IVA (Crédito Fiscal): Q. {{ duca.iva_gtq }}</em></p>
                    <h5 class="mt-3 text-success">Costo Inventario: Q. {{ duca.total_import_cost_gtq|floatformat:2 }}</h5>
                </div>
            </div>
        </div>
    </div>

<div class="row mb-5">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="text-secondary"><i class="bi bi-signpost-split me-2"></i>Rastreo del Contenedor</h4>
                <a href="{% url 'imports:tracking_add' duca.pk %}" class="btn btn-sm btn-primary shadow-sm">
                    <i class="bi bi-pin-map-fill me-1"></i> Registrar Nueva Ubicación
                </a>
            </div>
            
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    {% if duca.tracking_events.all %}
                        <div class="list-group list-group-flush">
                            {% for event in duca.tracking_events.all %}
                            <div class="list-group-item list-group-item-action d-flex gap-3 py-3 bg-transparent border-bottom">
                                <div class="text-primary fs-4 mt-1">
                                    <i class="bi bi-check-circle-fill"></i>
                                </div>
                                <div class="d-flex gap-2 w-100 justify-content-between">
                                    <div>
                                        <h6 class="mb-0 fw-bold">{{ event.get_event_type_display }}</h6>
                                        <p class="mb-0 text-muted small"><i class="bi bi-geo-alt-fill text-danger me-1"></i> {{ event.location }}</p>
                                        {% if event.notes %}
                                            <p class="mb-0 mt-2 p-2 bg-light rounded text-secondary small border"><i class="bi bi-info-circle me-1"></i>{{ event.notes }}</p>
                                        {% endif %}
                                    </div>
                                    <small class="opacity-50 text-nowrap fw-bold"><i class="bi bi-calendar-event me-1"></i> {{ event.event_date|date:"d M Y" }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center p-5 text-muted">
                            <i class="bi bi-compass fs-1 mb-3 text-secondary"></i>
                            <p>El contenedor aún no tiene eventos de rastreo registrados.</p>
                            <p class="small">Haz clic en "Registrar Nueva Ubicación" cuando el proveedor confirme la salida.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
<div class="row mb-5">
        <div class="col-12">
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="text-secondary"><i class="bi bi-signpost-split me-2"></i>Rastreo del Contenedor</h4>
                <a href="{% url 'imports:tracking_add' duca.pk %}" class="btn btn-sm btn-primary shadow-sm">
                    <i class="bi bi-pin-map-fill me-1"></i> Registrar Nueva Ubicación
                </a>
            </div>
            
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    {% if duca.tracking_events.all %}
                        <div class="list-group list-group-flush">
                            {% for event in duca.tracking_events.all %}
                            <div class="list-group-item list-group-item-action d-flex gap-3 py-3 bg-transparent border-bottom">
                                <div class="text-success fs-4 mt-1">
                                    <i class="bi bi-check-circle-fill"></i>
                                </div>
                                <div class="d-flex gap-2 w-100 justify-content-between">
                                    <div>
                                        <h6 class="mb-0 fw-bold">{{ event.get_event_type_display }}</h6>
                                        <p class="mb-0 text-muted small"><i class="bi bi-geo-alt-fill text-danger me-1"></i> {{ event.location }}</p>
                                        
                                        {% if event.notes %}
                                            <p class="mb-0 mt-2 p-2 bg-light rounded text-secondary small border">
                                                <i class="bi bi-info-circle me-1"></i>{{ event.notes }}
                                            </p>
                                        {% endif %}
                                    </div>
                                    <small class="opacity-75 text-nowrap fw-bold text-primary">
                                        <i class="bi bi-calendar-event me-1"></i> {{ event.event_date|date:"d/m/Y" }}
                                    </small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center p-5 text-muted bg-light rounded">
                            <i class="bi bi-compass fs-1 mb-3 text-secondary"></i>
                            <p class="mb-1">El contenedor aún no tiene eventos de rastreo registrados.</p>
                            <p class="small">Haz clic en <strong>"Registrar Nueva Ubicación"</strong> cuando el proveedor confirme la salida.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
    <h4 class="mb-3">Costo Unitario Real por Producto</h4>
    <div class="table-responsive bg-white shadow-sm rounded border">
        <table class="table table-hover table-striped mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Cant.</th>
                    <th>Producto</th>
                    <th>FOB Unitario</th>
                    <th>Factor Prorrateo</th>
                    <th>CIF Asignado ($)</th>
                    <th>DAI (Q)</th>
                    <th class="bg-success text-white">COSTO FINAL REAL (GTQ)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in duca.items.all %}
                <tr>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.description }} <br><small class="text-muted">{{ item.product_code }}</small></td>
                    <td>${{ item.fob_unit_usd }}</td>
                    <td>{{ item.factor_prorrateo|floatformat:4 }}</td>
                    <td>${{ item.calculated_cif_usd|floatformat:2 }}</td>
                    <td>Q. {{ item.calculated_dai_gtq|floatformat:2 }}</td>
                    <td class="bg-light fw-bold text-success fs-5">Q. {{ item.final_unit_cost_gtq|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}